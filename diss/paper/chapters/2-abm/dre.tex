
\section{Dynamic Resource Exchange}\label{abm:dre}

\subsection{Problem Statement}

As a next-generation nuclear fuel cycle simulation framework, Cyclus maintains a
primary goal of modeling flexibility. As facility, institutional, and regional
models are proposed, they should be relatively easily implemented and utilized
in the Cyclus simulation framework. Furthermore, the level of modeling
abstraction for different facilities in a fuel cycle will be different based on
the needs of archetype developer. Any supply-demand resolution framework,
therefore, must be able to support arbitrary facilities. One way to approach
such a problem is to treat facilities as black boxes, clearly defining a
supply-demand communication framework.

As stated previously in \S \ref{abm:abm}, a number of considerations must be
taken into account in such a framework. Supply and demand must be able to be
solved globally at any given time step. Resources must be able to be treated in
a fungible manner. The framework must be able to incorporate arbitrary,
agent-defined constraints. 

In order to address each of these concerns, the concept of a Dynamic Resource
Exchange (DRE) was developed and implemented. That process was motivated by the
following problem statement:

\begin{quote}
    If facilities are treated as individual black boxes and connections between
    facilities are determined dynamically, how does one match suppliers with
    demanders considering quantity and quality-based supply constraints,
    quantity and quality-based demand constraints, supply response to
    quality-based demands, and issues of fungibility?
\end{quote}

\subsection{Information Gathering}\label{abm:dre:info}

Supply-demand determination at any given time step begins with three
\textit{phases}, the terminology of which is influenced from previous supply
chain agent-based modeling work \cite{julka_agent-based_2002}. Importantly, this
information-gathering step is agnostic as to the actual matching algorithm used,
it is concerned only with querying the current status of supply and demand in
the simulation.

The first phase allows consumers of commodities to denote both the quantity of a
commodity they need to consume as well as the target isotopics, or quality, by
\textit{posting} their demand to the market exchange. This posting informs
producers of commodities what is needed by consumers, and is termed the
\textit{Request for Bids} (RFB) phase. Consumers are allowed to over-post, i.e.,
request more quantity than they can actually consume, as long as a corresponding
capacity constraint accompanies this posting. Further, consumers are allowed to
post demand for multiple commodities that may serve to meet the same combine
capacity. For example, consider an LWR that can be filled with MOX or UOX. It
can post a demand for both, but must define a preference over the set of
possible commodities it can consume. Another example is that of an advanced fuel
fabrication facility, i.e., one that fabricates fuel partially from separated
material that has already passed through a reactor. Such a facility can choose
to fill the remaining space in a certain assembly with various types of fertile
material, including depleted uranium from enrichment or reprocessed uranium from
separations. Accordingly, it could demand both commodities as long as it
provides a corresponding constraint with respect to total consumption. At the
completion of the RFB phase, the market exchange will have a set of consumption
portfolios, $P$, where each portfolio consists of a set requests, $R$, a
cardinal preference over the requests, $\alpha_R$, and possibly a set of
constraints over the requests, $C_R$. Each request consists of a quantity,
$q_r$, and a target isotopic vector, $I_r$.

The second phase allows suppliers to \textit{respond} to the set of consumption
portfolios, and is termed the \textit{Response to Request for Bids} (RRFB) phase
(analogous to Julka's Reply to Request for Quote phase
\cite{julka_agent-based_2002}). Each consumption portfolio is comprised of
requests for some set of commodities. Accordingly, for each request, suppliers
of that commodity denote production capacities and an isotopic profile of the
commodity they can provide. Suppliers are allowed to offer the null set of
isotopics as their profile, effectively providing no information. A supplier may
have its production constrained by more than one parameter. For example, a
processing facility may have both a throughput constraint (i.e., it can only
process material at a certain rate) and an inventory constraint (i.e., it can
only hold some total material). Further, the facility could have a constraint on
the quality of material to be processed, e.g., it may be able to handle a
maximum radiotoxicity for any given time step which is a function of both the
quantity of material in processes and the isotopic content of that material. The
formulation provided in \S\ref{sec:gfctp} allows for multiple of such
constraints as long as they are linear functions of the demanded commodity
quantity. At the completion of the RRFB phase the possible connections between
supplier and producer facilities, i.e., the arcs in the graph of the
transportation problem, have been established with specific capacity constraints
defined both by the quantity and quality of commodities that will traverse the
arcs.

The final phase of the information gathering procedure allows consumer
facilities to adjust their set of preferences and for managers of consumer
facilities to affect the consumer's set of preferences, as described in the
remaining sections. Accordingly, the last phase is termed the \textit{Preference
 Adjustment} (PA) phase. Preference adjustments can occur in response to the
set of responses provided by producer facilities. Consider the example of a
reactor facility that requests two fuel types, MOX and UOX. It may get two
responses to its request for MOX, each with different isotopic profiles of the
MOX that can be provided. It can then assign preference values over this set of
potential MOX providers. Another prime example is in the case of repositories. A
repository may have a defined preference of material to accept based upon its
heat load or radiotoxicity, both of which are functions of the quality, or
isotopics, of a material. In certain simulators, limits on fuel entering a
repository are imposed based upon the amount of time that has elapsed since the
fuel has exited a reactor, which can be assessed during this phase. The time
constraint is, in actuality, a constraint on heat load or radiotoxicity (one
must let enough of the fission products decay). A repository could analyze
possible input fuel isotopics and set the arc preference of any that violate a
given rule to 0, effectively eliminating that arc.

\subsection{Exchange Structure}

Upon completion of the information gathering phase, a \textit{bipartite} network
is formed. The network consists of receiving (request) nodes, $U$, and sending
(bid) nodes, $V$. For each request node, $u$, there may be many bid nodes;
however, there is a one-to-one mapping between bid nodes and request nodes. In
other words, a given bid node, $v$, is a unique response to a request node, $v$.

\TODO{Include figure}

There is not a direct analog between the \textit{portfolios} described in \S
\ref{abm:dre:info} and the bipartite graph structure. The notion of
\textit{portfolios} does map onto the formulation, however, and will be
described further in \S \ref{abm:dre:form}.

To ensure a feasible solution, additional nodes are added to both $U$
and $V$. A single bid node is added to $V$ and $N_{p}$ nodes are added to $U$,
where $N_{p}$ is the number of request portfolios. Thus, the total size of node
sets and the total number of arcs in the system are

\begin{equation}
  \left|{U}\right| = \left|{U}\right| + N_{p}
\end{equation}

\begin{equation}
  \left|{V}\right| = \left|{V}\right| + 1
\end{equation}

\begin{equation}
  \left|{A}\right| = \left|{A}\right| + N_{p}
\end{equation}

Each arc in the additional set, $A'$, is unconstrained (any amount of resource
flow is allowed) and is given a preference strictly less than the lowest
preference in the system, i.e.,

\begin{equation}
  p' < \min P.
\end{equation}

Accordingly, any additional arc will only be engaged if no other into a request
node, $u$, have available capacity and if the associated request portfolio is
not satisfied. Arc in $A'$ are referred to as \textit{false arcs}, because they
represent flows that do not exist in final solutions.

\TODO{Include figure}

\subsubsection{Commodities}

During the information gathering step in \S \ref{abm:dre:info}, consumers and
suppliers are queried based on \textit{commodities}. A consumer is allowed to
request multiple commodities, and a supplier is allowed to supply multiple
commodities; however, each possible resource transfer is based on a single
commodity. Accordingly, it is possible to color each arc, given a
commodity-to-color mapping.

For example, consider an exchange with three fuel commodities ($A$, $B$, $C$),
two requesters ($R_1$, $R_2$), and two suppliers ($S_1$, $S_2$) in the following
configuration:

\TODO{Include table}

Given the color map $A$: red, $B$: green, $C$: blue, the resulting exchange
graph can be colored:

\TODO{Include figure}

Importantly, the notion of commodities is critical during the information
gathering step and can be used to group arcs in an exchange graph. It also is
compelling when generating the formulation shown in \S
\ref{abm:dre:form}. However, given the constructed network graph, constraint
structure, and preference structure, the notion of commodities is not necessary
for the exchange graph to be solved.

\subsection{Mathematical Programming Formulation}\label{abm:dre:form}

\subsubsection{Overview}

An instance of supply and demand can be solved in a variety of ways. To solve
the system optimally, however, a formal investigation and solution structure is
needed. This section describes the construction of such a formulation.

The formulation is informed by the supply-demand parameters gathered by the
methodology described in the previous section. The basis for the formulation is
the Multi-commodity Transportation Problem described in \S\ref{intro:mtp} with
some departures described in detail below. Two separate formulations are
provided. The first is a strictly linear program. It is proposed a basis for
proof-of-principle work which may not fully adequately describe supply-demand
scenarios. A primary example of its shortcoming is that it allows split orders,
i.e., orders that are not fully filled. The nuclear fuel cycle deals with
bundled orders, such as nuclear fuel assemblies, thus this modeling paradigm is
only an approximation. Accordingly, a mixed integer-linear formulation is also
provided to address this concern. It splits the class of orders into two
distinct sets, one that allows order splitting and one that does not. Solving
the more complex problem will result in longer simulation times.  Accordingly,
one of the focuses of this research is to determine the effect on the simulation
between the two formulations and analyze the cases in which additional fidelity
is needed.

\subsubsection{The Nuclear Fuel Cycle Transportation Problem}

- basic formulation

- supply and demand constraints

\subsubsection{Adaptation for Fuel Assemblies}

- adaptation for assemblies

\subsection{A Heuristic Solution}

With full simluation domain knowledge of supply and demand, including false
arcs, a feasible solution can be found. By definition a feasible solution is a
\textit{solution} to the possible flow of resources, but not necessarily an
\textit{optimal} solution. Many heuristics may be applied to bipartite graphs
with constrainted flows. A simple \textit{greedy} heuristic is presented here
and implemented. 

\begin{algorithm}[h!]
 \SetAlgoLined
 \KwData{A resource exchange graph.}
 \KwResult{A valid set of resource flows.}
 sort request partitions by average preference\;
 \ForAll{request partitions, $J_r$} {
   sort requests by average preference\;
   matched $\leftarrow$ 0\;        
   \While{matched $\leq q_{J_r}$ and $\exists$ a request} {
     get next request\;
     sort incoming arcs by preference\;
     \While{matched $\leq q_{J_r}$ and $\exists$ an arc} {
       get next arc\;
       remaining $\leftarrow q_{J_r}$ - matched\;
       to\_match $\leftarrow \min \lbrace$remaining, Capacity(arc)$\rbrace$\;
       AddMatch(arc, to\_match)\;
       matched $\leftarrow$ matched + to\_match\;
     }
   }
 }
 \caption{Greedy Exchange Hueristic}\label{alg::greedy}
\end{algorithm}

The capacity of each arc in question is the most constraining value $s$
associated with either node on the arc. For a node $i \in I_b$ and $j \in J_r$,
the constraining value is defined as

\begin{equation}
  s = \min 
        \lbrace 
        \min \lbrace \frac{s_{I_b, k}}{\beta_{i, j, k}} 
        \: \forall k \in K_{I_b} \rbrace, 
        \: \min \lbrace \frac{s_{J_r, k}}{\beta_{i, j, k}} 
        \: \forall k \in K_{J_r} \rbrace
        \rbrace.
\end{equation}

The constraining values of each arc are updated upon declaration of a match in
Algorithm \ref{alg::greedy}.

\subsection{Proof of Principle}

physor paper
